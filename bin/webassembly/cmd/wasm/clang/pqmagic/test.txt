cmake_minimum_required(VERSION 3.10)

# PQMagic version.
project(PQMagic)

# Set c standard
set(CMAKE_BUILD_TYPE Release)
set(CMAKE_C_STANDARD 11)

# Use Emscripten compiler
set(CMAKE_C_COMPILER emcc)
set(CMAKE_AR emar)
set(CMAKE_RANLIB emranlib)

# Select PQMagic Version.
# Open Source Version Only Support PQMagic-std.
set(PQMAGIC_VERSION "std" CACHE STRING "Set PQMagic version")

if(NOT PQMAGIC_VERSION STREQUAL "std")
    message(FATAL_ERROR "Open Source Version Only Support PQMagic-std. Please set PQMAGIC_VERSION as \"std\" or contact as for further high performance support.")
endif()
message(STATUS "Use PQMagic-${PQMAGIC_VERSION}")

# Set default algorithm mode.
## KEM
set(DEFAULT_KYBER_MODES 2 3 4 CACHE STRING "All modes for Kyber algorithm")
set(DEFAULT_ML_KEM_MODES 512 768 1024 CACHE STRING "All modes for ML-KEM algorithm (FIPS 203)")
set(DEFAULT_AIGIS_ENC_MODES 1 2 3 4 CACHE STRING "All modes for Aigis-enc algorithm")
## SIG
set(DEFAULT_DILITHIUM_MODES 2 3 5 CACHE STRING "All modes for Dilithium algorithm")
set(DEFAULT_ML_DSA_MODES 44 65 87 CACHE STRING "All modes for ML-DSA algorithm (FIPS 204)")
set(DEFAULT_AIGIS_SIG_MODES 1 2 3 CACHE STRING "All modes for Aigis-sig algorithm")
set(DEFAULT_SLH_DSA_MODES
    slh-dsa-sm3-128f slh-dsa-sm3-128s
    slh-dsa-sha2-128f slh-dsa-sha2-128s slh-dsa-sha2-192f slh-dsa-sha2-192s slh-dsa-sha2-256f slh-dsa-sha2-256s
    slh-dsa-shake-128f slh-dsa-shake-128s slh-dsa-shake-192f slh-dsa-shake-192s slh-dsa-shake-256f slh-dsa-shake-256s
    CACHE STRING "All modes for SLH-DSA (FIPS 205 / SPHINCS+) algorithm")
set(DEFAULT_SPHINCS_A_MODES
    sphincs-a-sm3-128f sphincs-a-sm3-128s
    sphincs-a-sha2-128f sphincs-a-sha2-128s sphincs-a-sha2-192f sphincs-a-sha2-192s sphincs-a-sha2-256f sphincs-a-sha2-256s
    sphincs-a-shake-128f sphincs-a-shake-128s sphincs-a-shake-192f sphincs-a-shake-192s sphincs-a-shake-256f sphincs-a-shake-256s
    CACHE STRING "All modes for SPHINCS-Alpha algorithm")
set(DEFAULT_THASH robust simple CACHE STRING "All thash modes for SLH-DSA (FIPS 205 / SPHINCS+) and SPHINCS-Alpha algorithm") # Could be robust and simple

# User can pass mode for alg mode.
## KEM
set(KYBER_MODES ${DEFAULT_KYBER_MODES} CACHE STRING "Selected mode(s) for Kyber algorithm")
set(ML_KEM_MODES ${DEFAULT_ML_KEM_MODES} CACHE STRING "Selected mode(s) for ML-KEM algorithm (FIPS 203)")
set(AIGIS_ENC_MODES ${DEFAULT_AIGIS_ENC_MODES} CACHE STRING "Selected mode(s) for Aigis-enc algorithm")
## SIG
set(DILITHIUM_MODES ${DEFAULT_DILITHIUM_MODES} CACHE STRING "Selected mode(s) for Dilithium algorithm")
set(ML_DSA_MODES ${DEFAULT_ML_DSA_MODES} CACHE STRING "Selected mode(s) for ML-DSA algorithm (FIPS 204)")
set(AIGIS_SIG_MODES ${DEFAULT_AIGIS_SIG_MODES} CACHE STRING "Selected mode(s) for Aigis-sig algorithm")
set(SLH_DSA_MODES ${DEFAULT_SLH_DSA_MODES} CACHE STRING "Selected mode(s) for SLH-DSA (FIPS 205 / SPHINCS+) algorithm")
set(SLH_DSA_THASH ${DEFAULT_THASH} CACHE STRING "Selected thash mode(s) for SLH-DSA (FIPS 205 / SPHINCS+) algorithm")
set(SPHINCS_A_MODES ${DEFAULT_SPHINCS_A_MODES} CACHE STRING "Selected mode(s) for SPHINCS-Alpha algorithm")
set(SPHINCS_A_THASH ${DEFAULT_THASH} CACHE STRING "Selected thash mode(s) for SPHINCS-Alpha algorithm")

## KEM
option(ENABLE_KYBER "Enable Kyber" ON)
option(ENABLE_ML_KEM "Enable ML-KEM" ON)
option(ENABLE_AIGIS_ENC "Enable Aigis-enc" ON)
## SIG
option(ENABLE_DILITHIUM "Enable Dilithium" ON)
option(ENABLE_ML_DSA "Enable ML-DSA" ON)
option(ENABLE_AIGIS_SIG "Enable Aigis-sig" ON)
option(ENABLE_SLH_DSA "Enable SLH-DSA" ON)
option(ENABLE_SPHINCS_A "Enable SPHINCS-Alpha" ON)

if(
    NOT ENABLE_KYBER AND
    NOT ENABLE_ML_KEM AND
    NOT ENABLE_AIGIS_ENC AND
    NOT ENABLE_DILITHIUM AND
    NOT ENABLE_ML_DSA AND
    NOT ENABLE_AIGIS_SIG AND
    NOT ENABLE_SLH_DSA AND
    NOT ENABLE_SPHINCS_A)

    message(FATAL_ERROR "At least enable one algorithm, or use default config with all algorithm enabled. \nCurrent option: ENABLE_ML_KEM: ${ENABLE_ML_KEM}, ENABLE_KYBER: ${ENABLE_KYBER}, ENABLE_AIGIS_ENC: ${ENABLE_AIGIS_ENC}, ENABLE_ML_DSA: ${ENABLE_ML_DSA}, ENABLE_SLH_DSA: ${ENABLE_SLH_DSA}, ENABLE_DILITHIUM: ${ENABLE_DILITHIUM}, ENABLE_AIGIS_SIG: ${ENABLE_AIGIS_SIG}, ENABLE_SPHINCS_A: ${ENABLE_SPHINCS_A}. \nSupport algorithm: ML-KEM, Kyber, Aigis-enc, ML-DSA, SLH-DSA, Dilithium, Aigis-sig, SPHINCS-Alpha.")
endif()

## Hash Function
#  Default use sm3.
#  This hash selector do not work for SLH_DSA and SPHINCS_A
#  Change SLH_DSA_MODES and SPHINCS_A_MODES to select hash mode of SLH_DSA and SPHINCS_A.
option(USE_SM3 "Use sm3 as hash component." ON)
option(USE_SHAKE "Use shake as hash component." OFF)

if(USE_SHAKE)
    set(USE_SM3 OFF)
endif()

if(
    (USE_SHAKE AND USE_SM3) OR
    ((NOT USE_SHAKE) AND (NOT USE_SM3)))
    message(FATAL_ERROR "Choose hash mode by -DUSE_SM3=ON or -DUSE_SHAKE=ON")
endif()

if(USE_SM3)
message(STATUS "Hash Component: SM3")
elseif(USE_SHAKE)
message(STATUS "Hash Component: SHAKE")
endif()

# Set global compile options
if(NOT CMAKE_C_COMPILER_ID STREQUAL "Emscripten")
    add_compile_options(
        -Wall -Wextra -Wpedantic -Wmissing-prototypes -Wredundant-decls -Wshadow -fPIC
        -Wpointer-arith -Wa,--noexecstack -fomit-frame-pointer -O3 -mtune=native
        -march=native
    )
else()
    add_compile_options(
        -Wall -Wextra -Wpedantic -Wmissing-prototypes -Wredundant-decls -Wshadow -fPIC
        -Wpointer-arith -Wa,--noexecstack -fomit-frame-pointer -O3
    )
endif()
#################################
# Project library build setting #
#################################
# First get install dir.
set(INSTALL_DIR ${CMAKE_INSTALL_PREFIX} CACHE PATH "Installation directory")
# message(STATUS "Installation directory for PQMagic is: ${INSTALL_DIR}")
# Set install path
set(INSTALL_BIN_DIR ${INSTALL_DIR}/bin CACHE PATH "Executable installation directory")
set(INSTALL_LIB_DIR ${INSTALL_DIR}/lib CACHE PATH "Library installation directory")
set(INSTALL_INCLUDE_DIR ${INSTALL_DIR}/include CACHE PATH "Include installation directory")

# Show abs path for user.
get_filename_component(INSTALL_BIN_DIR_ABS ${INSTALL_BIN_DIR} ABSOLUTE)
get_filename_component(INSTALL_LIB_DIR_ABS ${INSTALL_LIB_DIR} ABSOLUTE)
get_filename_component(INSTALL_INCLUDE_DIR_ABS ${INSTALL_INCLUDE_DIR} ABSOLUTE)
message(STATUS "Installation executable path: ${INSTALL_BIN_DIR_ABS}")
message(STATUS "Installation library path: ${INSTALL_LIB_DIR_ABS}")
message(STATUS "Installation include path: ${INSTALL_INCLUDE_DIR_ABS}")

# Add subdir.
set(SUPPORT_ALG_STATIC_TARGET "")
set(SUPPORT_ALG_STATIC_TARGET_PATH "")
set(PQMAGIC_SHARED_LIB_NAME "libpqmagic_${PQMAGIC_VERSION}.so")
set(PQMAGIC_STATIC_LIB_NAME "libpqmagic_${PQMAGIC_VERSION}.a")
add_subdirectory(hash/sm3) # Add sm3
add_subdirectory(hash/keccak) # Add fips202
add_subdirectory(utils)
## KEM
if(ENABLE_KYBER)
    message(STATUS "KYBER: ENABLED with mode ${KYBER_MODES}")
    add_subdirectory(kem/kyber/${PQMAGIC_VERSION})
    # Record target name and path.
    list(APPEND SUPPORT_ALG_STATIC_TARGET kyber_static_target)
    list(APPEND SUPPORT_ALG_STATIC_TARGET_PATH "${CMAKE_BINARY_DIR}/kem/kyber/${PQMAGIC_VERSION}/libpqmagic_kyber_${PQMAGIC_VERSION}.a")
else()
    message(STATUS "KYBER: DISABLED")
endif()
if(ENABLE_ML_KEM)
    message(STATUS "ML-KEM (FIPS 203): ENABLED with mode ${ML_KEM_MODES}")
    add_subdirectory(kem/ml_kem/${PQMAGIC_VERSION})
    # Record target name and path.
    list(APPEND SUPPORT_ALG_STATIC_TARGET ml_kem_static_target)
    list(APPEND SUPPORT_ALG_STATIC_TARGET_PATH "${CMAKE_BINARY_DIR}/kem/ml_kem/${PQMAGIC_VERSION}/libpqmagic_ml_kem_${PQMAGIC_VERSION}.a")
else()
    message(STATUS "ML-KEM (FIPS 203): DISABLED")
endif()
if(ENABLE_AIGIS_ENC)
    message(STATUS "AIGIS-ENC: ENABLED with mode ${AIGIS_ENC_MODES}")
    add_subdirectory(kem/aigis-enc/${PQMAGIC_VERSION})
    # Record target name and path.
    list(APPEND SUPPORT_ALG_STATIC_TARGET aigis_enc_static_target)
    list(APPEND SUPPORT_ALG_STATIC_TARGET_PATH "${CMAKE_BINARY_DIR}/kem/aigis-enc/${PQMAGIC_VERSION}/libpqmagic_aigis_enc_${PQMAGIC_VERSION}.a")
else()
    message(STATUS "AIGIS-ENC: DISABLED")
endif()
## SIG
if(ENABLE_DILITHIUM)
    message(STATUS "DILITHIUM: ENABLED with mode ${DILITHIUM_MODES}")
    add_subdirectory(sig/dilithium/${PQMAGIC_VERSION})
    # Record target name and path.
    list(APPEND SUPPORT_ALG_STATIC_TARGET dilithium_static_target)
    list(APPEND SUPPORT_ALG_STATIC_TARGET_PATH "${CMAKE_BINARY_DIR}/sig/dilithium/${PQMAGIC_VERSION}/libpqmagic_dilithium_${PQMAGIC_VERSION}.a")
else()
    message(STATUS "DILITHIUM: DISABLED")
endif()
if(ENABLE_ML_DSA)
    message(STATUS "ML-DSA (FIPS 204): ENABLED with mode ${ML_DSA_MODES}")
    add_subdirectory(sig/ml_dsa/${PQMAGIC_VERSION})
    # Record target name and path.
    list(APPEND SUPPORT_ALG_STATIC_TARGET ml_dsa_static_target)
    list(APPEND SUPPORT_ALG_STATIC_TARGET_PATH "${CMAKE_BINARY_DIR}/sig/ml_dsa/${PQMAGIC_VERSION}/libpqmagic_ml_dsa_${PQMAGIC_VERSION}.a")
else()
    message(STATUS "ML-DSA (FIPS 204): DISABLED")
endif()
if(ENABLE_AIGIS_SIG)
    message(STATUS "AIGIS_SIG: ENABLED with mode ${AIGIS_SIG_MODES}")
    add_subdirectory(sig/aigis-sig/${PQMAGIC_VERSION})
    # Record target name and path.
    list(APPEND SUPPORT_ALG_STATIC_TARGET aigis_sig_static_target)
    list(APPEND SUPPORT_ALG_STATIC_TARGET_PATH "${CMAKE_BINARY_DIR}/sig/aigis-sig/${PQMAGIC_VERSION}/libpqmagic_aigis_sig_${PQMAGIC_VERSION}.a")
else()
    message(STATUS "AIGIS_SIG: DISABLED")
endif()
if(ENABLE_SLH_DSA)
    message(STATUS "SLH-DSA (FIPS 205): ENABLED with mode ${SLH_DSA_MODES}")
    add_subdirectory(sig/slh_dsa/${PQMAGIC_VERSION})
    # Record target name and path.
    list(APPEND SUPPORT_ALG_STATIC_TARGET slh_dsa_static_target)
    list(APPEND SUPPORT_ALG_STATIC_TARGET_PATH "${CMAKE_BINARY_DIR}/sig/slh_dsa/${PQMAGIC_VERSION}/libpqmagic_slh_dsa_${PQMAGIC_VERSION}.a")
else()
    message(STATUS "SLH_DSA (FIPS 205): DISABLED")
endif()
if(ENABLE_SPHINCS_A)
    message(STATUS "SPHINCS-Alpha: ENABLED with mode ${SPHINCS_A_MODES}")
    add_subdirectory(sig/sphincs-a/${PQMAGIC_VERSION})
    # Record target name and path.
    list(APPEND SUPPORT_ALG_STATIC_TARGET sphincs_a_static_target)
    list(APPEND SUPPORT_ALG_STATIC_TARGET_PATH "${CMAKE_BINARY_DIR}/sig/sphincs-a/${PQMAGIC_VERSION}/libpqmagic_sphincs_a_${PQMAGIC_VERSION}.a")
else()
    message(STATUS "SPHINCS-Alpha: DISABLED")
endif()

# Common include dir.
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/utils)
include_directories(${CMAKE_CURRENT_SOURCE_DIR})


# Set a custom target for shared library
add_custom_target(pqmagic_target ALL
    COMMAND ${CMAKE_C_COMPILER} -shared -o ${PQMAGIC_SHARED_LIB_NAME}
            -Wl,--whole-archive
            ${SUPPORT_ALG_STATIC_TARGET_PATH}
            $<TARGET_FILE:sm3>
            $<TARGET_FILE:fips202>
            $<TARGET_FILE:randombytes>
            -Wl,--no-whole-archive
    DEPENDS ${SUPPORT_ALG_STATIC_TARGET} sm3 fips202 randombytes
    COMMENT "Generating shared library ${PQMAGIC_SHARED_LIB_NAME}"
)

# sm3 and randombytes target's default path.
set(SM3_LIB_PATH ${CMAKE_BINARY_DIR}/hash/sm3)
set(FIPS202_LIB_PATH ${CMAKE_BINARY_DIR}/hash/keccak)
set(RANDOMBYTES_LIB_PATH ${CMAKE_BINARY_DIR}/utils)
# Set mri script for archive library combination.
file(WRITE ${CMAKE_BINARY_DIR}/ar_script.mri "CREATE ${PQMAGIC_STATIC_LIB_NAME}\n")
foreach(lib_path ${SUPPORT_ALG_STATIC_TARGET_PATH})
    file(APPEND ${CMAKE_BINARY_DIR}/ar_script.mri "ADDLIB ${lib_path}\n")
endforeach()
file(APPEND ${CMAKE_BINARY_DIR}/ar_script.mri "ADDLIB ${SM3_LIB_PATH}/libsm3.a\n")
file(APPEND ${CMAKE_BINARY_DIR}/ar_script.mri "ADDLIB ${FIPS202_LIB_PATH}/libfips202.a\n")
file(APPEND ${CMAKE_BINARY_DIR}/ar_script.mri "ADDLIB ${RANDOMBYTES_LIB_PATH}/librandombytes.a>\n")
file(APPEND ${CMAKE_BINARY_DIR}/ar_script.mri "SAVE\nEND\n")

# Set a custom target for static library
add_custom_target(pqmagic_static_target ALL
    COMMAND ${CMAKE_AR} -M < ${CMAKE_BINARY_DIR}/ar_script.mri
    DEPENDS ${SUPPORT_ALG_STATIC_TARGET} sm3 fips202 randombytes
    COMMENT "Generating static library CREATE ${PQMAGIC_STATIC_LIB_NAME}\n"
)


add_library(pqmagic SHARED IMPORTED)
set_target_properties(pqmagic PROPERTIES
    IMPORTED_LOCATION ${PQMAGIC_SHARED_LIB_NAME}
)

add_library(pqmagic_static STATIC IMPORTED)
set_target_properties(pqmagic_static PROPERTIES
    IMPORTED_LOCATION ${PQMAGIC_STATIC_LIB_NAME}
)

# Install lib.
install(FILES ${CMAKE_BINARY_DIR}/${PQMAGIC_SHARED_LIB_NAME}
    DESTINATION ${INSTALL_LIB_DIR})
install(FILES ${CMAKE_BINARY_DIR}/${PQMAGIC_STATIC_LIB_NAME}
    DESTINATION ${INSTALL_LIB_DIR})
# Custom install all executable target.
install(CODE
    "
    message(STATUS \"Create soft link library for: ${INSTALL_LIB_DIR}/${PQMAGIC_STATIC_LIB_NAME}\")
    execute_process(COMMAND ln -s ${INSTALL_LIB_DIR}/${PQMAGIC_STATIC_LIB_NAME} ${INSTALL_LIB_DIR}/libpqmagic.a)
    message(STATUS \"Create soft link library for: ${INSTALL_LIB_DIR}/${PQMAGIC_SHARED_LIB_NAME}\")
    execute_process(COMMAND ln -s ${INSTALL_LIB_DIR}/${PQMAGIC_SHARED_LIB_NAME} ${INSTALL_LIB_DIR}/libpqmagic.so)
    "
)

###########################
# Add test binary for alg #
###########################
# Used for add test correctness binary
function(add_algorithm_test TARGET_NAME SOURCE_FILE ALG_NAME TYPE MODE)

    # Define other argument.
    set(options)
    set(oneValueArgs THASH MODE_NAMESPACE)
    set(multiValueArgs)

    # Parse arguments
    cmake_parse_arguments(ADD_ALGO_TEST "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    if(NOT ADD_ALGO_TEST_THASH)
        set(